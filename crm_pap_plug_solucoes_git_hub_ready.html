<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM PAP – Plug Soluções</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --txt:#e5e7eb; --accent:#10b981; --danger:#ef4444; --warn:#f59e0b; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:linear-gradient(120deg,#0b1220,#101826 60%,#0b1220);color:var(--txt)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;margin-bottom:16px}
    h1{font-size:22px;margin:0}
    .badge{font-size:12px;padding:6px 10px;border:1px solid #1f2937;border-radius:999px;color:var(--muted)}
    .panel{background:rgba(17,24,39,.7);backdrop-filter: blur(6px);border:1px solid #1f2937;border-radius:16px;padding:16px;margin:16px 0}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1f2937;background:#0b1220;color:var(--txt)}
    textarea{min-height:72px}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    .actions{display:flex;flex-wrap:wrap;gap:10px}
    button{border:0;border-radius:12px;padding:10px 14px;color:#071018;background:#1f2937;cursor:pointer}
    button.primary{background:var(--accent);color:#051a12;font-weight:700}
    button.warn{background:var(--warn);color:#1a1205}
    button.danger{background:var(--danger)}
    .table{width:100%;border-collapse:collapse;border-spacing:0}
    .table th,.table td{border-bottom:1px solid #1f2937;padding:10px;text-align:left;font-size:13px}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid #1f2937;font-size:11px}
    .pill.quente{background:#064e3b;color:#34d399}
    .pill.morno{background:#3f2d12;color:#fbbf24}
    .pill.frio{background:#1f2937;color:#94a3b8}
    .footer{color:var(--muted);font-size:12px;margin-top:6px}
    details{margin:8px 0}
    .hint{color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .card{flex:1 1 160px;background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:12px}
    .kpi .card .n{font-weight:800;font-size:18px}
    .link{color:#60a5fa;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>CRM PAP – Plug Soluções</h1>
        <div class="footer">Preencha leads no PAP. Use o link com <code>?vendedora=SeuNome</code> para personalizar.</div>
      </div>
      <div class="badge" id="vendedoraBadge">Vendedora: —</div>
    </header>

    <section class="panel">
      <div class="grid">
        <div class="col-4">
          <label>Data</label>
          <input id="dataContato" type="date" />
        </div>
        <div class="col-8">
          <label>Nome da Empresa</label>
          <input id="empresa" placeholder="Ex.: Contábil Minas LTDA" />
        </div>
        <div class="col-6">
          <label>Responsável pelo Contato</label>
          <input id="responsavel" placeholder="Ex.: Ana Paula" />
        </div>
        <div class="col-6">
          <label>Telefone/WhatsApp</label>
          <input id="telefone" placeholder="(XX) XXXXX-XXXX" />
        </div>
        <div class="col-12">
          <label>Endereço</label>
          <input id="endereco" placeholder="Rua, nº, bairro, cidade" />
        </div>
        <div class="col-6">
          <label>Volume de Impressões/Mês</label>
          <select id="volume">
            <option value="até 2.000">até 2.000</option>
            <option value="2.000–5.000">2.000–5.000</option>
            <option value="> 5.000">acima de 5.000</option>
          </select>
        </div>
        <div class="col-6">
          <label>Situação Atual</label>
          <select id="situacao">
            <option value="Tem impressora própria">Tem impressora própria</option>
            <option value="Já aluga de terceiros">Já aluga de terceiros</option>
            <option value="Sem solução definida">Sem solução definida</option>
          </select>
        </div>
        <div class="col-6">
          <label>Interesse Identificado</label>
          <select id="interesse">
            <option value="Frio">Frio</option>
            <option value="Morno">Morno</option>
            <option value="Quente">Quente</option>
          </select>
        </div>
        <div class="col-6">
          <label>Status do Lead</label>
          <select id="status">
            <option>Novo contato</option>
            <option>Em negociação</option>
            <option>Proposta enviada</option>
            <option>Fechado (ganho)</option>
            <option>Perdido</option>
          </select>
        </div>
        <div class="col-12">
          <label>Observações</label>
          <textarea id="obs" placeholder="Informações úteis (ex.: modelo desejado, volume real, dor atual)"></textarea>
        </div>
        <div class="col-12 actions">
          <button class="primary" id="addBtn">Adicionar Lead</button>
          <button id="csvBtn">Exportar CSV do Dia</button>
          <button class="warn" id="whatsBtn">Copiar relatório WhatsApp</button>
          <button class="danger" id="resetBtn" title="Limpa somente o dia atual">Zerar dia atual</button>
        </div>
        <div class="col-12 hint">Dica: gere o relatório ao fim do dia. Os dados ficam salvos no aparelho (localStorage) por vendedora e por data.</div>
      </div>
    </section>

    <section class="panel">
      <h3 style="margin-top:0">Leads do dia</h3>
      <div class="kpi" id="kpis"></div>
      <div style="overflow:auto;margin-top:10px">
        <table class="table" id="leadsTable">
          <thead>
            <tr>
              <th>Empresa</th>
              <th>Contato</th>
              <th>Telefone</th>
              <th>Volume</th>
              <th>Situação</th>
              <th>Interesse</th>
              <th>Status</th>
              <th>Obs.</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <details>
        <summary>Configurações de Relatório</summary>
        <div class="grid">
          <div class="col-12">
            <label>Observações gerais (opcional, aparece no final do relatório)</label>
            <textarea id="obsGerais" placeholder="Resumo do dia, objeções mais comuns, próximos passos..."></textarea>
          </div>
        </div>
      </details>
    </section>

    <footer class="footer">Plug Soluções • CRM PAP leve e offline-first • Feito para GitHub Pages</footer>
  </div>

<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const params = new URLSearchParams(location.search);
  const vendedora = params.get('vendedora') || 'Sem nome';
  const todayStr = new Date().toISOString().slice(0,10);
  const KEY = (d=todayStr)=>`plugpap:${vendedora}:${d}`;

  // Elements
  const badge = $('#vendedoraBadge');
  const inputs = {
    data: $('#dataContato'), empresa: $('#empresa'), resp: $('#responsavel'), tel: $('#telefone'), end: $('#endereco'),
    vol: $('#volume'), sit: $('#situacao'), int: $('#interesse'), sta: $('#status'), obs: $('#obs')
  };
  const obsGerais = $('#obsGerais');
  const tbody = document.querySelector('#leadsTable tbody');
  const kpis = $('#kpis');

  // Init
  badge.textContent = `Vendedora: ${vendedora}`;
  inputs.data.value = todayStr;
  render();

  // Handlers
  $('#addBtn').addEventListener('click', addLead);
  $('#resetBtn').addEventListener('click', ()=>{ if(confirm('Zerar todos os leads do dia atual?')){ localStorage.removeItem(KEY()); render(); }});
  $('#csvBtn').addEventListener('click', exportCSV);
  $('#whatsBtn').addEventListener('click', copyWhats);

  function getDayData(){
    const raw = localStorage.getItem(KEY());
    return raw ? JSON.parse(raw) : { leads: [], obsGerais: '' };
  }
  function setDayData(data){ localStorage.setItem(KEY(), JSON.stringify(data)); }

  function addLead(){
    const lead = {
      data: inputs.data.value || todayStr,
      empresa: inputs.empresa.value.trim(),
      resp: inputs.resp.value.trim(),
      tel: inputs.tel.value.trim(),
      end: inputs.end.value.trim(),
      vol: inputs.vol.value,
      sit: inputs.sit.value,
      int: inputs.int.value,
      sta: inputs.sta.value,
      obs: inputs.obs.value.trim(),
      id: crypto.randomUUID()
    };
    if(!lead.empresa){ alert('Informe o nome da empresa.'); return; }
    const data = getDayData();
    data.leads.push(lead);
    data.obsGerais = obsGerais.value;
    setDayData(data);
    clearForm();
    render();
  }

  function clearForm(){
    inputs.empresa.value = '';
    inputs.resp.value = '';
    inputs.tel.value = '';
    inputs.end.value = '';
    inputs.vol.value = 'até 2.000';
    inputs.sit.value = 'Tem impressora própria';
    inputs.int.value = 'Frio';
    inputs.sta.value = 'Novo contato';
    inputs.obs.value = '';
  }

  function render(){
    const data = getDayData();
    obsGerais.value = data.obsGerais || '';
    tbody.innerHTML = '';
    data.leads.forEach(L=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(L.empresa)}</td>
        <td>${esc(L.resp)}</td>
        <td>${esc(L.tel)}</td>
        <td>${esc(L.vol)}</td>
        <td>${esc(L.sit)}</td>
        <td>${pill(L.int)}</td>
        <td>${esc(L.sta)}</td>
        <td title="${esc(L.obs)}">${esc(L.obs).slice(0,40)}${L.obs.length>40?'…':''}</td>
        <td><a href="#" data-id="${L.id}" class="link del">remover</a></td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('a.del').forEach(a=>a.addEventListener('click', (ev)=>{
      ev.preventDefault();
      const id = a.getAttribute('data-id');
      const data = getDayData();
      const idx = data.leads.findIndex(x=>x.id===id);
      if(idx>-1){ data.leads.splice(idx,1); setDayData(data); render(); }
    }));
    renderKPIs(data.leads);
  }

  function renderKPIs(leads){
    const total = leads.length;
    const byStatus = group(leads, 'sta');
    const ganhos = (byStatus['Fechado (ganho)']||[]).length;
    const perda = (byStatus['Perdido']||[]).length;
    const prop = (byStatus['Proposta enviada']||[]).length;
    const neg = (byStatus['Em negociação']||[]).length;
    const conv = total? ((ganhos/total)*100).toFixed(1): '0.0';

    kpis.innerHTML = '';
    const cards = [
      ['Leads adicionados', total],
      ['Em negociação', neg],
      ['Propostas enviadas', prop],
      ['Fechados (ganhos)', ganhos],
      ['Perdidos', perda],
      ['Conversão (%)', conv]
    ];
    cards.forEach(([t,n])=>{
      const c = document.createElement('div');
      c.className='card';
      c.innerHTML = `<div class="n">${n}</div><div class="footer">${t}</div>`;
      kpis.appendChild(c);
    });
  }

  function group(arr, key){
    return arr.reduce((acc,cur)=>{ (acc[cur[key]] ||= []).push(cur); return acc; },{});
  }

  function pill(int){
    const c = int.toLowerCase();
    return `<span class="pill ${c}">${int}</span>`;
  }

  function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  function exportCSV(){
    const {leads} = getDayData();
    if(!leads.length){ alert('Nenhum lead para exportar.'); return; }
    const cols = ['Data','Empresa','Responsável','Telefone','Endereço','Volume','Situação','Interesse','Status','Observações'];
    const rows = leads.map(L=>[
      L.data, L.empresa, L.resp, L.tel, L.end, L.vol, L.sit, L.int, L.sta, L.obs.replaceAll('\n',' ')
    ]);
    const csv = [cols.join(';')].concat(rows.map(r=>r.map(cell=>`"${(cell||'').replaceAll('"','""')}"`).join(';'))).join('\n');
    download(`leads_${vendedora}_${todayStr}.csv`, csv, 'text/csv');
  }

  function download(filename, content, type){
    const blob = new Blob([content], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }

  function formatWhats(){
    const {leads} = getDayData();
    const byStatus = group(leads,'sta');
    const total = leads.length;
    const ganhos = (byStatus['Fechado (ganho)']||[]).length;
    const perda = (byStatus['Perdido']||[]).length;
    const prop = (byStatus['Proposta enviada']||[]).length;
    const neg = (byStatus['Em negociação']||[]).length;
    const conv = total? ((ganhos/total)*100).toFixed(1): '0.0';

    const topPotenciais = leads
      .slice()
      .sort((a,b)=> score(b)-score(a))
      .slice(0,5);

    function score(L){
      let s=0;
      if(L.int==='Quente') s+=3; else if(L.int==='Morno') s+=1;
      if(L.vol==='2.000–5.000') s+=1; else if(L.vol==='> 5.000' || L.vol==='acima de 5.000') s+=3;
      if(L.sta==='Em negociação') s+=1; if(L.sta==='Proposta enviada') s+=2; if(L.sta==='Fechado (ganho)') s+=4;
      return s;
    }

    const dBR = new Date(todayStr+'T00:00:00').toLocaleDateString('pt-BR');
    const header = [
      `Relatório – PAP Plug Soluções – ${dBR} – ${vendedora}`,
      `- Leads adicionados: ${total}`,
      `- Em negociação: ${neg}`,
      `- Propostas enviadas: ${prop}`,
      `- Fechados (ganhos): ${ganhos}`,
      `- Perdidos: ${perda}`,
      `- Conversão: ${conv}%`,
      ``,
      `Top potenciais (prioridade)`,
      ...topPotenciais.map((L,i)=> `- ${i+1}. ${L.empresa} – ${L.resp || 's/contato'} – ${L.tel || 's/tel'} – Vol: ${L.vol} – ${L.int} – ${L.sta}`)
    ];

    const outros = leads.length? [
      '',
      'Demais leads do dia',
      ...leads.filter(L=>!topPotenciais.includes(L)).map(L=> `- ${L.empresa} – ${L.int} – ${L.sta}${L.obs?` – Obs: ${L.obs}`:''}`)
    ] : [];

    const extra = obsGerais.value.trim()? ['', 'Observações gerais', `- ${obsGerais.value.trim()}`] : [];

    return header.concat(outros).concat(extra).join('\n');
  }

  async function copyWhats(){
    const text = formatWhats();
    try{
      await navigator.clipboard.writeText(text);
      alert('Relatório copiado! Cole no WhatsApp.');
    }catch(e){
      // fallback: abre WhatsApp Web com o texto
      const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(url, '_blank');
    }
  }
})();
</script>
</body>
</html>
